#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞ AppImage Fixer
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/create_release.sh <version>
# –ü—Ä–∏–º–µ—Ä: ./scripts/create_release.sh 1.0.0

set -e

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
if [ $# -eq 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–∫–∞–∑–∞–Ω–∞ –≤–µ—Ä—Å–∏—è"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <version>"
    echo "–ü—Ä–∏–º–µ—Ä: $0 1.0.0"
    exit 1
fi

VERSION=$1

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≤–µ—Ä—Å–∏–∏
if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤–µ—Ä—Å–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç X.Y.Z"
    exit 1
fi

echo "üöÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ v$VERSION..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –º—ã –Ω–∞ –≤–µ—Ç–∫–µ main
CURRENT_BRANCH=$(git branch --show-current)
if [ "$CURRENT_BRANCH" != "main" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –í—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –≤–µ—Ç–∫–µ main –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞"
    echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –Ω–µ—Ç –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
if ! git diff-index --quiet HEAD --; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ï—Å—Ç—å –Ω–µ–∑–∞–∫–æ–º–º–∏—á–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    echo "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–ª–∏ –æ—Ç–º–µ–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ä–µ–ª–∏–∑–∞"
    exit 1
fi

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –≤ __init__.py
echo "üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ –≤ __init__.py..."
sed -i "s/__version__ = \".*\"/__version__ = \"$VERSION\"/" appimage_fixer/__init__.py

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CHANGELOG.md
echo "üìù –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CHANGELOG.md..."
TODAY=$(date +%Y-%m-%d)
sed -i "s/## \[Unreleased\]/## [Unreleased]\n\n## [$VERSION] - $TODAY/" CHANGELOG.md

# –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
echo "üíæ –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
git add appimage_fixer/__init__.py CHANGELOG.md
git commit -m "Bump version to $VERSION"

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞
echo "üè∑Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞ v$VERSION..."
git tag -a "v$VERSION" -m "Release v$VERSION"

# –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ —Ç–µ–≥–∞
echo "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏ —Ç–µ–≥–∞..."
git push origin main
git push origin "v$VERSION"

echo "‚úÖ –†–µ–ª–∏–∑ v$VERSION —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
echo "üì¶ GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–µ—Ä–µ—Ç –∏ –æ–ø—É–±–ª–∏–∫—É–µ—Ç –ø–∞–∫–µ—Ç"
echo "üîó –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º: https://github.com/wolfDiesel/appimage_fixer/actions"
